  {% extends "skeleton.html" %}
  {% load staticfiles %}

  {% block custom_style %}
      <link rel="stylesheet" type="text/css" href="{% static "sharewall-template/css/highslide.css" %}"/>
      <link rel="stylesheet" media="screen" type="text/css" href="{% static "sharewall-template/css/datepicker.css" %}"/>
      <script type="text/javascript" src="{% static "sharewall-template/js/datepicker.js" %}"></script>
      <script type="text/javascript" src="{% static "sharewall-template/js/eye.js" %}"></script>
      <script type="text/javascript" src="{% static "sharewall-template/js/utils.js" %}"></script>

  {% endblock %}    

  {% block title %}{{ page.title }}{% endblock %}

	{% block content %}
  <div class="sBusyOverlay2" id="isEmpty" style="height: calc(100% - 139px); margin-top:62px; line-height:600px;">Необходимо cоздать площадку!</div>
  <div class="sBusyOverlay">Загрузка...</div>
  <div class="sHeight-Auto">
      <div class="sContainer sMargin-Auto">
          <div class="sListConstructors">
              
              <h2 class="sH2">Статистика</h2>
              <span class="sTextAlign-C sTabs" data-tabs="1">Шаринг</span>
              <span class="sTextAlign-C sTabs" data-tabs="2">Социальный трафик</span>
              <span class="sTextAlign-C sTabs" data-tabs="3">Заработок</span>
              <span class="sTextAlign-C sTabs" data-tabs="4">Страницы</span>
              <div class="sGLine"></div>
              <div class="sDatePicker" style="margin-top:26px;">
                    <label for="inputDate">Период: </label>
                    <div class="sInputDateWrapper"> 
                      <input class="inputDate" id="inputDate" value="">
                        <span class="sCalendarIcon" onclick="showDatePicker()"></span>
                    </div>
                    <span class="sFilterShow" onclick="filterDateShow()">По дате</span>
                    <p id="date2"></p>
              </div>
              <div class="sAreaChoices-Line">
                {% if user.is_staff and not request.session.profile %}
                <span class="sFloat-L" style="cursor:default;">ID вебмастера</span>
                <div class="sFloat-L sAreaSelectWrapper" style="margin-left:20px; width:50px;">
                  <select name="webmaster_id">
                    {% for pk, name in users_data %} 
                    <option value="{{ pk }}">{{ pk }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ name }}</option>
                    {% endfor %} 
                  </select>
                </div>
                {% endif %}

                <a href="/webmaster-area/" class="sFloat-L">Площадки</a>
                <div class="sAreaSelectWrapper">
                  <select name="webmaster_area">
                    {% for a in areas %} 
                    <option>{{ a.name_area }}</option>
                    {% endfor %} 
                  </select>
                </div>
              </div> 
              <div class="sStatistic">
                <div data-tabs="1"></div>
                <div data-tabs="2"></div>
                <div data-tabs="4">
                
            <div class="sTableAreas" style="margin-top:5px; margin-bottom:40px; max-height: 680px; overflow-y: auto;">
                
            <div class="sPos-Rel sFloat-L sChatShowCount">
              <span>Найдено 0 страниц</span>
            </div>
            <div class="sPos-Rel sFloat-R sPager">
                <span style="vertical-align: bottom; line-height: 35px;">Страница 1 из 1</span>
                <span class="sRoute" data-route="b"></span>
                <span class="sRoute" data-route="f"></span>
            </div>
            <div class="sClear-Both"></div>
          
                <div class="sTableAreasFieldName">
                    <div class="sTableAreasField" style="width:74px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">Позиция</span>
                    </div>
                    <div class="sTableAreasField" style="width:500px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">Страница</span>
                    </div>
                    <div class="sTableAreasField" style="width:100px; text-align:center;"><span data-sort="sharing" style="cursor:pointer; color: #008bd4; padding:0 10px 0 10px; text-align:center;">Шаринг</span>
                    </div>
                    <div class="sTableAreasField" style="width:150px; text-align:center;"><span data-sort="traffic" style="cursor:pointer; color: #008bd4; padding:0 10px 0 10px; text-align:center;">Cоц. трафик</span>
                    </div>
                    <div class="sTableAreasField" style="width:330px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">Подробно</span>
                    </div>
                </div>

                    
                </div>
              </div>
          </div>
      </div>
  </div>
	{% endblock %}

  {% block footer_script %}

        <script>

            var _lpd;

            $(function(){
                {% if user.is_staff and request.session.profile and not request.session.profile.is_staff and areas.count < 1 or not user.is_staff and areas.count < 1 %}
                 $('div.sBusyOverlay2#isEmpty').show();
                {% endif %}

                {% if user.is_staff and not request.session.profile %}
                 $('select[name="webmaster_id"]').val({{ user.pk }});
                {% endif %}

                $('.sListConstructors > span.sTabs').click(function(){
                  $this = $(this); 
                  $this.parent().find('span.sTabs').removeClass('sActive'); 
                  $this.addClass('sActive'); 
                  var tabNumber = $this.data('tabs'); 
                  $('.sStatistic > div').hide();
                  $('.sStatistic > div[data-tabs="'+tabNumber+'"]').show();
                });
                $('<iframe  style="width: 100%; " frameborder="0" scrolling="no" id="detail"></iframe>').appendTo('.sStatistic > div[data-tabs="1"]');
                $('<iframe  style="width: 100%; " frameborder="0" scrolling="no" id="detail-social"></iframe>').appendTo('.sStatistic > div[data-tabs="2"]');
                $('.sListConstructors > span:first-of-type()').click();

                {% if user.is_staff and not request.session.profile %}
                  $('select[name="webmaster_id"]').change(function(){ 
                      var selected_id_val = $(this).find('option:selected').val();

                      $.ajax({ 
                        url: "/admin/area-by-id/", 
                        data: {
                          "wmid": selected_id_val
                        }, 
                        beforeSend: function(){
                          $('div.sBusyOverlay').show();
                        },
                        success: function(r){ 
                          if(r.answer='ok'){ 

                            $select_area = $('select[name="webmaster_area"]').empty();

                            if(r.areas.length < 1){
                              $('.sStatistic').hide();
                            }
                            else{
                              r.areas.forEach(function(v,i){  
                                $select_area.append('<option>'+v+'</option>');
                              }); 
                              
                              $('select[name="webmaster_area"]').find('option:nth-of-type(1)').prop('selected',true).closest('select').trigger('change');
                              $('.sStatistic').show();
                            }

                          } 
                        },
                        complete: function(){
                          $('div.sBusyOverlay').hide();
                        }
                      });

                  });
                {% endif %}

                $('select[name="webmaster_area"]').change(function(){ 
                  try{
                    $('div.sBusyOverlay').show();
                    $this = $(this);
                    var selected_area_text = $this.find('option:selected').text();

                    $('.sStatistic > div').show();

                    {% if user.is_staff and not request.session.profile %}
                      var selected_id_val = $('select[name="webmaster_id"]').find('option:selected').val();
                      $('.sStatistic > div[data-tabs="1"] > iframe').attr('src','/webmaster-area/detail/'+selected_area_text+'/?wmid='+selected_id_val).css('min-height','590px');
                      setTimeout(function(){
                        $('.sStatistic > div[data-tabs="2"] > iframe').attr('src','/webmaster-area/detail-social/'+selected_area_text+'/?wmid='+selected_id_val).css('min-height','590px');
                      }, 500);
                    {% else %}
                      $('.sStatistic > div[data-tabs="1"] > iframe').attr('src','/webmaster-area/detail/'+selected_area_text).css('min-height','590px');
                      setTimeout(function(){
                        $('.sStatistic > div[data-tabs="2"] > iframe').attr('src','/webmaster-area/detail-social/'+selected_area_text).css('min-height','590px');
                      }, 500);
                    {% endif %}
                  }
                  catch(e){
                    $('div.sBusyOverlay').hide();
                  }
                }).find('option:nth-of-type(1)').prop('selected',true).closest('select').trigger('change'); 

                $('#date2').DatePicker({
                    flat: true,
                    format: 'd.m.Y',
                    date: ['10.04.2016','30.04.2016'],
                    current: '11.04.2016',
                    calendars: 3,
                    mode: 'range',
                    starts: 1,
                    onChange: function(formated, dates){
                    $('#inputDate').val(formated[0]+" " +"-"+" "+formated[1]);

                    }
                }).hide();

                $('[data-sort]').click(function(){
                  sortPageDetail($(this).data('sort'));
                });

            });

            function setDatePicker(start, end){
                $('#date2').DatePickerSetDate([start, end], true);
            }

            function showDatePicker(){
                $('#date2').slideToggle(400);
            }

            function filterDateShow(){
                try{
                  $('div.sBusyOverlay').show();
                  var selected_area_text = $('select[name="webmaster_area"]').find('option:selected').text();

                  $('.sStatistic > div').show();

                  {% if user.is_staff and not request.session.profile %}
                    var selected_id_val = $('select[name="webmaster_id"]').find('option:selected').val();
                    $('.sStatistic > div[data-tabs="1"] > iframe').attr('src','/webmaster-area/detail/'+selected_area_text+'/?daterange='+$('#inputDate').val()+'&wmid='+selected_id_val).css('min-height','590px');
                    setTimeout(function(){
                      $('.sStatistic > div[data-tabs="2"] > iframe').attr('src','/webmaster-area/detail-social/'+selected_area_text+'/?daterange='+$('#inputDate').val()+'&wmid='+selected_id_val).css('min-height','590px');
                    }, 500);
                  {% else %}
                    $('.sStatistic > div[data-tabs="1"] > iframe').attr('src','/webmaster-area/detail/'+selected_area_text+'/?daterange='+$('#inputDate').val()).css('min-height','590px');
                    setTimeout(function(){
                      $('.sStatistic > div[data-tabs="2"] > iframe').attr('src','/webmaster-area/detail-social/'+selected_area_text+'/?daterange='+$('#inputDate').val()).css('min-height','590px');
                    }, 500);
                  {% endif %}
                }
                catch(e){
                  $('div.sBusyOverlay').hide();
                }
            }

            function fillPages(lpd){
              $('.sChatShowCount > span').text('Найдено '+lpd.length+' страниц');
              _lpd = lpd;
                
              sortPageDetail('sharing');
            }

             function sortPageDetail(by){

                $('.sTableAreasCell').remove();
                $('[data-detail="true"]').remove();

                _lpd.sort(function(a,b){

                  if(by=='sharing'){
                    return (a.sharing < b.sharing ? 1 : -1);
                  }else{
                    return (a.traffic < b.traffic ? 1 : -1);
                  }
                }).forEach(function(v,k){
                  $('.sTableAreas').append('<div class="sTableAreasCell"><div class="sTableAreasField" style="width:74px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">'+k+'</span></div><div class="sTableAreasField" style="width:500px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;"><a style="padding-left:0px;" href="'+v.url+'">'+v.title+'</a></span></div><div class="sTableAreasField" style="width:100px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">'+v.sharing+'</span></div><div class="sTableAreasField" style="width:150px; text-align:center;"><span style="padding:0 10px 0 10px; text-align:center;">'+v.traffic+'</span></div><div class="sTableAreasField" style="width:330px; text-align:center;"><span data-event="detail" data-chatstate="answered" style="cursor: pointer; padding:0 10px 0 10px; text-align:center; width:100px; margin:0 auto;">Подробней</span></div></div>').append('<div data-detail="true" style="display:none;"><div class="sTableAreasFieldName"><div class="sTableAreasField" style="width:162px;"><span style="padding:0 20px 0 20px; text-align:center;"></span></div><div class="sTableAreasField" style="width:110px;"><span style="padding:0 20px 0 20px; text-align:center;">Вконтакте</span></div><div class="sTableAreasField" style="width:100px;"><span style="padding:0 20px 0 20px; text-align:center;">Facebook</span></div><div class="sTableAreasField" style="width:85px;"><span style="padding:0 20px 0 20px; text-align:center;">Twitter</span></div><div class="sTableAreasField" style="width:145px;"><span style="padding:0 20px 0 20px; text-align:center;">Одноклассники</span></div><div class="sTableAreasField" style="width:92px;"><span style="padding:0 20px 0 20px; text-align:center;">Google+</span></div><div class="sTableAreasField" style="width:154px;"><span style="padding:0 20px 0 20px; text-align:center;">МойМир@Mail.ru</span></div><div class="sTableAreasField" style="width:94px;"><span style="padding:0 20px 0 20px; text-align:center;">LinkedIn</span></div><div class="sTableAreasField" style="width:115px;"><span style="padding:0 20px 0 20px; text-align:center;">LiveJournal</span></div></div><div class="sTableAreasCell"><div class="sTableAreasField" style="width:162px;"><span style="padding:0 20px 0 20px; text-align:center; color: #40a70d;">Шаринг</span></div><div class="sTableAreasField" style="width:110px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[0]+'</span></div><div class="sTableAreasField" style="width:100px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[1]+'</span></div><div class="sTableAreasField" style="width:85px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[2]+'</span></div><div class="sTableAreasField" style="width:145px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[3]+'</span></div><div class="sTableAreasField" style="width:92px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[4]+'</span></div><div class="sTableAreasField" style="width:154px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[5]+'</span></div><div class="sTableAreasField" style="width:94px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[6]+'</span></div><div class="sTableAreasField" style="width:115px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.sharing_detail.split(",")[7]+'</span></div></div><div class="sTableAreasCell"><div class="sTableAreasField" style="width:162px;"><span style="padding:0 20px 0 20px; text-align:center; color: #40a70d;">Соц. трафик</span></div><div class="sTableAreasField" style="width:110px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[0]+'</span></div><div class="sTableAreasField" style="width:100px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[1]+'</span></div><div class="sTableAreasField" style="width:85px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[2]+'</span></div><div class="sTableAreasField" style="width:145px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[3]+'</span></div><div class="sTableAreasField" style="width:92px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[4]+'</span></div><div class="sTableAreasField" style="width:154px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[5]+'</span></div><div class="sTableAreasField" style="width:94px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[6]+'</span></div><div class="sTableAreasField" style="width:115px;"><span style="padding:0 20px 0 20px; text-align:center;">'+v.traffic_detail.split(",")[7]+'</span></div></div></div>');
                });

              $('[data-event="detail"]').click(function(){ 
                $(this).closest('.sTableAreasCell').next('div[data-detail="true"]').toggle(); 
              });

             }

        </script>

  {% endblock %}
