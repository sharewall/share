{% extends "skeleton.html" %}
{% load staticfiles %}

{% block custom_style %}
  <style>
      input:checked + label.sBSInput{
        background: url("{% static "sharewall-template/images/bs-chekbox-checked.png" %}");
      }
      .sBSInput{
        margin-right:4px;
      }
      
      .fileform {
        border-radius: 7px 20px 20px 7px;
        background-color: #FFFFFF;
        height: 29px;
        /*overflow: hidden;*/
        padding: 2px;
        position: relative;
        text-align: left;
        vertical-align: middle;
        width: 350px;
        overflow: visible;
        z-index: 0;
      }
      .fileform #fileformlabel {
        background-color: #FFFFFF;
        float: left;
        height: 22px;
        line-height: 22px;
        overflow: hidden;
        padding: 2px 0px 2px 5px;
        text-align: left;
        vertical-align: middle;
        width: 215px;
      }
      .fileform .selectbutton {
        font-family: 'roboto';
        font-size: 14px;
        background-color: #A2A3A3;
        border-radius: 20px;
        color: #FFFFFF;
        float: right;
        height: 35px;
        line-height: 35px;
        /*overflow: hidden;*/
        text-align: center;
        width: 135px;
        position: absolute;
        top: -1px;
        right: 0;
        overflow: visible;
        z-index: 2!important;
        cursor: pointer;
      }  
      .fileform #add_files {
        position: relative;
        overflow: hidden;
        bottom: 28px;
        left: 218px;
        width: 135px;
        -moz-opacity: 0;
        filter: alpha(opacity=0);
        opacity: 0;
        font-size: 150px;
        height: 30px;
        z-index: 2;
        cursor: pointer!important;
      }
  </style>
{% endblock %}  

{% block title %}{{ page.title }}{% endblock %}

{% block content %}
<div class="sContent-PB">
  <div class="sContainer sMargin-Auto">

      <div class="sH1Wrapper" style="padding-bottom: 32px;">
          <h1 class="sH1 sFloat-L">{{ page.header }}</h1>   
          <div class="sClear-Both"></div>
      </div> 
      
      <div class="sChatWrapper sChatWrapper-Wm">
          <form id="createChat" style="display:none; opacity:0;" method="post" action="/chat/create/" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="submit" />
          </form>
          <div class="sChatMainWrapper">
              <div class="sFloat-L">
                  <label for="add_header">Тема</label>
                  {% if user.is_staff %}
                    <label for="add_wmId">ID вебмастера</label>
                  {% endif %}
                  <label for="add_department">Отдел</label>
                  <label for="add-text">Сообщение</label>
                  <label for="add-files" style="margin-top: 140px;">Вложения</label>
              </div>
              <div class="sFloat-L">
                  <div>
                      <input form="createChat" id="add_header" name="header" value="" maxlength="100" required="" type="text">
                  </div>
                  {% if user.is_staff %}
                    <div style="width: 185px; overflow: hidden; background: url(../images/select-area-arrow.png) no-repeat right #fff;">
                      <select form="createChat" id="add_wmId" name="to_user_pk" style="background: #FFF;">
                        {% for pk, name in users_data %} 
                        <option value="{{ pk }}">{{ pk }}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ name }}</option>
                        {% endfor %} 
                      </select>
                    </div>
                  {% endif %}
                  <div class="sNone">
                      <label class="sFloat-L" style="padding-right:29px;">Служба поддержки
                        <input form="createChat" id="add_department_sup" name="department" value="SUP" style="opacity:0; display:none; margin-left:9999px;" type="radio">
                        <label for="add_department_sup" class="sBSInput"></label>
                      </label>
                      <label class="sFloat-L">Биллинг
                        <input form="createChat" id="add_department_bil" name="department" value="BIL" style="opacity:0; display:none; margin-left:9999px;" type="radio">
                        <label for="add_department_bil" class="sBSInput"></label>
                      </label>
                  </div>
                  <div>
                      <textarea required="" id="add_text" name="text" form="createChat"></textarea>
                  </div>
                  <div class="sNone">
                      <div class="fileform sFloat-L">
                        <div id="fileformlabel"></div>
                        <div class="selectbutton">Выберите файл
                            <span class="sFilesCounter" style="display:none;">0</span>  
                            <span class="sFilesReset" style="display:none;" title="Удалить"></span>
                        </div>
                        <input form="createChat" type="file" name="files" id="add_files" multiple="multiple"/>
                      </div>
                      <span class="sFloat-R" style="width:190px; font: 400 14px Roboto;">
                          Разрешённые типы файлов:
                          jpg,jpeg,gif,png,pdf
                      </span>
                  </div>
              </div>
              <div class="sClear-Both"></div>
          </div>
          <div class="sChatFooterWrapper">
            <span class="sChatSubmitBtn" data-event="submit">Отправить</span>
            <span class="sChatSubmitBtn" data-event="cancel">Отмена</span> 
          </div>
      </div>
      
  </div>
</div>
{% endblock %}

{% block footer_script %}
<script>
    
    $(function(){        
    
        $('#add_files').change(function(){
            $files = $(this.files);
            if($files.length > 0){
              $('.sFilesCounter').text($files.length).show();
              $('.sFilesReset').show();  
            }else{
              $('.sFilesCounter').text(0).hide();
              $('.sFilesReset').hide();
            }
            //console.log($files);
            
            $label = $('#fileformlabel');
            $label.text('');
            var allowed_types = ['image/jpeg','image/pjpeg','image/png','image/gif','application/pdf'];
            
            $.each($files, function(i,f){
              console.log(f);
                
              if($.inArray(f.type, allowed_types) < 0){
                  $('.sFilesReset').click();
                  return false;
              }
             
              $label.text($label.text().concat(f.name+', '));
            });
            
            $label.text($label.text().slice(0,-2));
        }).change();
        
        $('.sFilesReset').click(function(){
            $('#add_files').val('').change();
        });
        
        $('.sChatSubmitBtn[data-event="submit"]').click(function(){
            //console.log($('form#createChat').serialize());
            $('form#createChat').find('input[type="submit"]').click();
        });
        
        $('.sChatSubmitBtn[data-event="cancel"]').click(function(){
            document.location = "/chat/";
        });
        
        $('#add_department_sup').prop('checked', true);
    });
   
</script>
{% endblock %}
